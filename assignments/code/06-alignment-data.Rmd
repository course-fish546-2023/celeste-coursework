---
title: "06-alignment-data"
output: html_document
date: "2023-05-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Task 1

Curling in sorted.bam files: 
```{r, engine='bash'}         
cd ../data
curl -O https://gannet.fish.washington.edu/seashell/bu-mox/scrubbed/120321-cvBS/19F_R1_val_1_bismark_bt2_pe.deduplicated.sorted.bam
curl -O https://gannet.fish.washington.edu/seashell/bu-mox/scrubbed/120321-cvBS/19F_R1_val_1_bismark_bt2_pe.deduplicated.sorted.bam.bai
```

Curling in reference genome:
```{r, engine='bash'}         
cd ../data
curl -O https://gannet.fish.washington.edu/seashell/bu-mox/data/Cvirg-genome/GCF_002022765.2_C_virginica-3.0_genomic.fa
curl -O https://gannet.fish.washington.edu/seashell/bu-mox/data/Cvirg-genome/GCF_002022765.2_C_virginica-3.0_genomic.fa.fai
```

Using tview to quickly take a peak at the sorted.bam file and genome (looking at alignment data against genome)
```{r, engine='bash'}
/home/shared/samtools-1.12/samtools tview \
../data/19F_R1_val_1_bismark_bt2_pe.deduplicated.sorted.bam \
../data/GCF_002022765.2_C_virginica-3.0_genomic.fa
```

# Task 2
## Creating bam files

For this task we will align RNAseq data to a reference genome using HISat2 and then proceed to visualize it with IGV.

Fist we download the fastq files:
```{r, engine='bash'}
cd ../data
curl -O https://owl.fish.washington.edu/nightingales/C_gigas/F143n08_R2_001.fastq.gz
curl -O https://owl.fish.washington.edu/nightingales/C_gigas/F143n08_R1_001.fastq.gz
```

Next we download some genome references:
```{r, engine='bash'}
cd ../data
curl -O https://gannet.fish.washington.edu/panopea/Cg-roslin/cgigas_uk_roslin_v1_genomic-mito.fa
curl -O https://gannet.fish.washington.edu/panopea/Cg-roslin/cgigas_uk_roslin_v1_genomic-mito.fa.fai
curl -O https://gannet.fish.washington.edu/panopea/Cg-roslin/GCF_902806645.1_cgigas_uk_roslin_v1_genomic-mito.gtf
```

Creating reference index using the gtf file with HISat2
```{r, engine='bash'}
/home/shared/hisat2-2.2.1/hisat2-build \
-f ../data/cgigas_uk_roslin_v1_genomic-mito.fa \
../output/cgigas_uk_roslin_v1_genomic-mito.index
```

Alignment of the RNAseq data with hisat2:
```{r, engine='bash'}
/home/shared/hisat2-2.2.1/hisat2 \
-x ../output/cgigas_uk_roslin_v1_genomic-mito.index \
-p 4 \
-1 ../data/F143n08_R1_001.fastq.gz \
-2 ../data/F143n08_R2_001.fastq.gz \
-S ../output/F143_cgigas.sam
```


Peaking at the alignment data (SAM file format):
```{r, engine='bash'}
tail -1 ../output/F143_cgigas.sam
```

Next we are create a bam file from the sam file

```{r, engine ='bash'}
/home/shared/samtools-1.12/samtools view \
-@ 7 \
-Su ../output/F143_cgigas.sam \
| /home/shared/samtools-1.12/samtools sort - \
-@ 7 \
-o ../output/F143_cgigas.sorted.bam 
/home/shared/samtools-1.12/samtools index ../output/F143_cgigas.sorted.bam
```

## Using bcftools's mpileup to create mapping scores..



```{r, engine ='bash'}
#!/bin/bash

# loop through all sorted.bam files
for file in ../output/*.sorted.bam; do

    # get the sample name from the filename
    sample=$(basename $file .sorted.bam)

    # run mpileup
    /home/shared/bcftools-1.14/bcftools mpileup --threads 4 --no-BAQ \
    --fasta-ref ../data/cgigas_uk_roslin_v1_genomic-mito.fa \
    $file > ../output/${sample}_mpileup_output.txt
done

```



#### SR code
```{r, engine='bash'}
/home/shared/bcftools-1.14/bcftools mpileup --threads 4 --no-BAQ \
--fasta-ref ../data/cgigas_uk_roslin_v1_genomic-mito.fa \
../output/F143_cgigas.sorted.bam > ../output/F143_mpileup_output.txt
```

```{r, engine='bash'}
tail ../output/F143_cgigas_mpileup_output.txt
```

```{r, engine='bash'}
/home/shared/bcftools-1.14/bcftools call -Oz -v -m ../output/F143_cgigas_mpileup_output.txt > ../output/F143_mpile.vcf.gz
```


```{r, engine='bash'}
zgrep "^##" -v ../output/F143_mpile.vcf.gz | \
awk 'BEGIN{OFS="\t"} {split($8, a, ";"); print $1,$2,$4,$5,$6,a[1],$9,$10}' | head

```


```{r, engine='bash'}
/home/shared/bcftools-1.14/bcftools call \
-v -c ../output/F143_mpile.vcf.gz \
> ../output/F143_mpile_calls.vcf
```


#### chat gpt version
```{r, engine='bash'}
/home/shared/bcftools-1.14/bcftools mpileup --threads 4 --no-BAQ \
--fasta-ref ../data/cgigas_uk_roslin_v1_genomic-mito.fa \
../output/*.sorted.bam | /home/shared/bcftools-1.14/bcftools call -Oz -v -m -o ../output/F143_mpile.vcf.gz
```
``

